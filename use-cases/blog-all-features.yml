---
# Blog applications

version: '3.8'

services:
  rproxy:
    deploy:
      labels:
        ecs.task.family: bignicefamily
  app01:
    secrets:
      - testsecret
    deploy:
      labels:
        ecs.task.family: bignicefamily
      replicas: 2
    environment:
      name: toto
      LOGLEVEL: INFO
      ACCOUNT_ID: "${AWS::AccountId}"
      REGION: "${AWS::Region}"
    x-configs:
      scaling:
        range: "1-10"
        target_scaling:
          cpu_target: 80
      use_xray: True
      network:
        is_public: True
        lb_type: application

  app02:
    x-configs:
      scaling:
        range: "0-20"

  app03:
    x-configs:
      scaling:
        range: "1-10"
        allow_zero: True
        target_scaling:
          cpu_target: 75
          memory_target: 80
          disable_scale_in: False
          scale_out_cooldown: 60
      use_xray: True
      iam:
        boundary: arn:aws:iam::aws:policy/PowerUserAccess
        policies:
          - name: somenewpolicy
            document:
              Version: 2012-10-17
              Statement:
                - Effect: Allow
                  Action:
                    - ec2:Describe*
                  Resource:
                    - "*"
                  Sid: "AllowDescribeAll"


x-appmesh:
  Properties:
    MeshName: root
  Settings:
    nodes:
      - name: app03
        protocol: http
      - name: app02
        protocol: http
      - name: bignicefamily
        protocol: http
        backends:
          - dateteller # Points to the dateteller service, not router!
    routers:
      - name: dateteller
        listener:
          port: 5000
          protocol: http
        routes:
          http:
            - match:
                prefix: /date
                method: GET
                scheme: http
              nodes:
                - name: app02
                  weight: 1
            - match:
                prefix: /date/utc
              nodes:
                - name: app03
                  weight: 1
    services:
      - name: api
        node: bignicefamily
      - name: dateteller
        router: dateteller

x-dns:
  PrivateNamespace:
    Name: mycluster.lan
  PublicNamespace:
    Name: lambda-my-aws.io

x-sqs:
  queueA:
    Properties:
      QueueName: abcd
      RedrivePolicy:
        deadLetterTargetArn: queueB
        maxReceiveCount: 4
    Settings:
      EnvNames:
        - QUEUEA
    Services:
      - name: app03
        access: RWMessages
        scaling:
          steps:
            - lower_bound: 0
              upper_bound: 10
              count: 1
            - lower_bound: 10
              upper_bound: 20
              count: 2
            - lower_bound: 20
              count: 21

  queueB:
    Properties:
      QueueName: x-y-z
    Settings:
      EnvNames:
        - QUEUEB
    Services:
      - name: rproxy
        access: RWMessages
      - name: app02
        access: RWMessages
        scaling:
          steps:
            - lower_bound: 0
              upper_bound: 10
              count: 1
            - lower_bound: 10
              upper_bound: 20
              count: 2
  queueC:
    Properties:
      FifoQueue: True
      QueueName: x-y-z
    Settings:
      EnvNames:
        - QUEUEB
    Services:
      - name: rproxy
        access: RWMessages

x-sns:
  Topics:
    topicA:
      Properties: {}
      Services:
        - name: bignicefamily
          access: Publish
        - name: app03
          access: Publish
    topicB:
      Properties:
        Subscription:
          - Endpoint: queueB
            Protocol: sqs

x-rds:
  dbA:
    Properties:
      Engine: "aurora-mysql"
      EngineVersion: "5.7.12"
    Settings:
      EnvNames:
        - DBA
    Services:
      - name: bignicefamily
        access: RW
      - name: app03
        access: RW

x-dynamodb:
  tableA:
    Properties:
      AttributeDefinitions:
        - AttributeName: "ArtistId"
          AttributeType: "S"
        - AttributeName: "Concert"
          AttributeType: "S"
        - AttributeName: "TicketSales"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "ArtistId"
          KeyType: "HASH"
        - AttributeName: "Concert"
          KeyType: "RANGE"
      GlobalSecondaryIndexes:
        - IndexName: "GSI"
          KeySchema:
            - AttributeName: "TicketSales"
              KeyType: "HASH"
          Projection:
            ProjectionType: "KEYS_ONLY"
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
    Services:
      - name: app03
        access: RW
      - name: bignicefamily
        access: RO

  tableB:
    Properties:
      AttributeDefinitions:
        - AttributeName: "Album"
          AttributeType: "S"
        - AttributeName: "Artist"
          AttributeType: "S"
        - AttributeName: "Sales"
          AttributeType: "N"
        - AttributeName: "NumberOfSongs"
          AttributeType: "N"
      KeySchema:
        - AttributeName: "Album"
          KeyType: "HASH"
        - AttributeName: "Artist"
          KeyType: "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      GlobalSecondaryIndexes:
        - IndexName: "myGSI"
          KeySchema:
            - AttributeName: "Sales"
              KeyType: "HASH"
            - AttributeName: "Artist"
              KeyType: "RANGE"
          Projection:
            NonKeyAttributes:
              - "Album"
              - "NumberOfSongs"
            ProjectionType: "INCLUDE"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
        - IndexName: "myGSI2"
          KeySchema:
            - AttributeName: "NumberOfSongs"
              KeyType: "HASH"
            - AttributeName: "Sales"
              KeyType: "RANGE"
          Projection:
            NonKeyAttributes:
              - "Album"
              - "Artist"
            ProjectionType: "INCLUDE"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      LocalSecondaryIndexes:
        - IndexName: "myLSI"
          KeySchema:
            - AttributeName: "Album"
              KeyType: "HASH"
            - AttributeName: "Sales"
              KeyType: "RANGE"
          Projection:
            NonKeyAttributes:
              - "Artist"
              - "NumberOfSongs"
            ProjectionType: "INCLUDE"

    Services:
      - name: app02
        access: RW
    Settings:
      EnvNames:
        - TABLEB
        - tableb

  tableC:
    Lookup:
      Tags:
        - name: tableC
    Services:
      - name: app02
        access: RO

x-kms:
  keyA:
    Properties: {}
    Settings:
      Alias: alias/keyA
    Services:
      - name: bignicefamily
        access: EncryptDecrypt

  keyB:
    Properties:
      PendingWindowInDays: 14
    Settings:
      Alias: keyB
    Services:
      - name: app02
        access: SQS
      - name: app03
        access: EncryptOnly
      - name: bignicefamily
        access: DecryptOnly

x-tags:
  costcentre: abcd
  contact: you@me.com

x-vpc:
  Create:
    VpcCidr: 10.21.42.0/24
    SingleNat: True

#  Lookup:
#    VpcId:
#      tags:
#        - Name: vpcwork
#    AppSubnets:
#      tags:
#        - vpc::usage: application
#    StorageSubnets:
#      tags:
#        - vpc::usage: storage
#    PublicSubnets:
#      tags:
#        - vpc::usage: public


x-cluster:
#  Properties:
#    CapacityProviders:
#      - FARGATE
#      - FARGATE_SPOT
#    ClusterName: testabcd
#    DefaultCapacityProviderStrategy:
#      - CapacityProvider: FARGATE_SPOT
#        Weight: 4
#        Base: 2
#      - CapacityProvider: FARGATE
#        Weight: 1

  Lookup: test2

secrets:
  testsecret:
    external: true
    x-secrets:
      Name: /path/to/my/secret

  testabcdsecret:
    file: /dev/null
    x-secrets:
      Name: /nowhere
      LinksTo:
        - EcsTaskRole
