{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "services.x-logging.spec.json",
  "id": "services.x-logging",
  "type": "object",
  "title": "services.x-logging specification",
  "description": "The services.x-logging specification for ComposeX",
  "additionalProperties": false,
  "properties": {
    "RetentionInDays": {
      "type": "integer",
      "description": "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html#cfn-logs-loggroup-retentionindays"
    },
    "FireLens": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "FireLensService": {
              "type": "string",
              "description": "Name of the service in compose file to use as FireLens log router"
            },
            "FirelensConfiguration": {
              "$ref": "#/definitions/FirelensConfiguration"
            }
          }
        },
        {
          "type": "object",
          "oneOf": [
            {
              "required": [
                "Shorthands"
              ]
            },
            {
              "required": [
                "Advanced"
              ]
            }
          ],
          "properties": {
            "Shorthands": {
              "$ref": "#/definitions/FireLensShortCuts"
            },
            "Advanced": {
              "$ref": "#/definitions/FireLensAdvancedConfig"
            }
          }
        },
        {
          "type": "boolean",
          "description": "Simple option to automatically use FireLens with CloudWatch logs destination",
          "default": false
        }
      ]
    }
  },
  "definitions": {
    "FireLensShortCuts": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ReplaceAwsLogs": {
          "type": "boolean",
          "default": false,
          "description": "If set to true, will use FireLens with CloudWatch logs instead of awslogs driver"
        },
        "FirelensConfiguration": {
          "$ref": "#/definitions/FirelensConfiguration"
        }
      }
    },
    "FirelensConfiguration": {
      "type": "object",
      "description": "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-firelensconfiguration.html",
      "additionalProperties": false,
      "properties": {
        "Type": {
          "type": "string",
          "description": "Which fluent to use. FluentD only works when using FireLensService.",
          "default": "fluentbit",
          "enum": [
            "fluentbit",
            "fluentd"
          ]
        },
        "Options": {
          "type": "object",
          "additionalProperties": false,
          "dependencies": {
            "config-file-type": {
              "required": [
                "config-file-value"
              ]
            }
          },
          "properties": {
            "enable-ecs-log-metadata": {
              "type": "boolean",
              "default": true
            },
            "config-file-type": {
              "type": "string",
              "enum": [
                "file",
                "s3"
              ]
            },
            "config-file-value": {
              "type": "string"
            }
          }
        }
      }
    },
    "FireLensAdvancedConfig": {
      "type": "object",
      "oneOf": [
        {
          "required": [
            "s3FileConfiguration"
          ]
        },
        {
          "required": [
            "Rendered"
          ]
        }
      ],
      "properties": {
        "LogDriverBufferLimit": {
          "type": "number",
          "minimum": 33554432,
          "maximum": 536870912,
          "default": 67108864,
          "description": "Allows to change log-driver-buffer-limit and set the RAM for the fluent container accordingly"
        },
        "FirelensConfiguration": {
          "$ref": "#/definitions/FirelensConfiguration"
        },
        "s3FileConfiguration": {
          "oneOf": [
            {
              "type": "string",
              "description": "Native path syntax to the configuration file for FireLens, i.e. arn:aws:s3:::bucket/file.conf.",
              "pattern": "arn:aws(-[a-z-]+)?:s3:::([a-zA-Z-.\\d][^/]+)/([\\S]+)$"
            },
            {
              "type": "object",
              "description": "Object that allows you to define s3 bucket and path to config file separately. using x-s3 will replace the value accordingly and deal with permissions",
              "properties": {
                "BucketName": {
                  "type": "string",
                  "description": "bucket name. can be x-s3::<logical_bucket>."
                },
                "FilePath": {
                  "type": "string",
                  "description": "Path to the config file, i.e. firelens/myapp.conf"
                }
              }
            }
          ]
        },
        "Rendered": {
          "type": "object",
          "description": "Allows to generate a file that will be placed in shared volume. Configuration content is stored in AWS SSM",
          "properties": {
            "SourceFile": {
              "type": "string",
              "description": "Path to the source file that contains the configuration"
            },
            "EnableHeathCheck": {
              "type": "boolean",
              "default": true
            },
            "GracePeriod": {
              "type": "number",
              "minimum": 5,
              "maximum": 120,
              "default": 30,
              "description": "Time in seconds for GRACE period before the container stops after receiving SIGTERM"
            },
            "ComposeXManagedAwsDestinations": {
              "type": "array",
              "uniqueItems": true,
              "description": "Generates automatically a new OUTPUT for a Compose-X managed resource",
              "items": {
                "oneOf": [
                  {
                    "$ref": "#/definitions/FireLensCloudWatchManagedDestination"
                  },
                  {
                    "$ref": "#/definitions/FireLensFirehoseManagedDestination"
                  }
                ]
              }
            },
            "EnvironmentVariables": {
              "$ref": "#/definitions/RenderEnvVars"
            }
          }
        }
      }
    },
    "FireLensFirehoseManagedDestination": {
      "type": "object",
      "required": [
        "delivery_stream"
      ],
      "description": "Allows to setup all settings from https://docs.fluentbit.io/manual/pipeline/outputs/firehose.",
      "additionalProperties": true,
      "properties": {
        "delivery_stream": {
          "type": "string",
          "description": "Allows to define delivery_stream with simple name or a delivery stream defined in x-kinesis_firehose."
        }
      }
    },
    "FireLensCloudWatchManagedDestination": {
      "type": "object",
      "description": "Allows to define all settings from https://docs.fluentbit.io/manual/pipeline/outputs/cloudwatch",
      "required": [
        "log_group_name"
      ],
      "properties": {
        "log_group_name": {
          "type": "string",
          "description": "Value for log_group_name from the original plugin."
        }
      }
    },
    "RenderEnvVars": {
      "type": "object",
      "description": "Allows to specify extra environment variables to the ",
      "patternProperties": {
        "^[a-zA-Z\\d._-]+$": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "object",
              "additionalProperties": false,
              "description": "Allows to use CFN Ref or Sub functions directly",
              "properties": {
                "Fn::Sub": {
                  "type": "string"
                },
                "Fn::Ref": {
                  "type": "string"
                }
              },
              "oneOf": [
                {
                  "required": [
                    "Fn::Ref"
                  ]
                },
                {
                  "required": [
                    "Fn::Sub"
                  ]
                }
              ]
            }
          ]
        }
      }
    }
  }
}
